---
title: "Raport z badania klinicznego WTM2020"
author: "Dr. med. W. Francuzik"
date: "25.05.2020"
output: 
    bookdown::word_document2:
      fig_caption: yes
---

```{r}
# Load packages
pacman::p_load(tidyverse, here, ggpubr,chron,data.table)

# Load data cleanded from 1_data_cleaning
df <- read_rds(here("analysis/data/raw_data/clean_df.Rds"))
data <- df$data %>% filter(record_id %in% names(df$json_data))
start <- data %>% filter(redcap_event_name=="initial_visit_arm_1")
end <- data %>% filter(redcap_event_name=="end_of_study_visit_arm_1")
output <- df$output
json_data <- df$json_data
mean_frame <- df$mean_frame # srednie różnice miedzy sensorem a manualem
mean_frame$id <- rownames(mean_frame)
comp <- bind_rows(lapply(output, `[`, c(1))) #wszystkie wartosci manual/sensor
comp <- comp$comp
compare_frame <- bind_rows(lapply(output, `[`, c(2))) # srednie temperatury sensora dla kazdego pacjenta(json)
compare_frame <- compare_frame$comp_mean
rownames(compare_frame) <- names(json_data)
names_json <- names(json_data)
final_df <- list()

```


# Demografia

W badaniu wzięło udział `r length(data$record_id %>% unique())` pacjentów oddziału chirurgicznego, którzy po wyrażeniu pisemnej świadomej i poinformowanej zgody na badanie zostali wyposażeni w czujnik temperatury WARMIE umieszczony w jednej z predefiniowanych lokalizacji: a) ramię, b) nadgarstek, c) udo, d) klatka piersiowa. 


```{r figagesex, fig.cap="Wiek i płeć pacjentów właczonych do badania."}
#Years old
start %>% summarise(mean_age=mean(years_old))

ggboxplot(start, "gender.factor", "years_old",
      xlab="",ylab="Years Old",
      fill = "gender.factor",
      palette = c("#00AFBB", "#E7B800"),
      add ="jitter")+
  theme(legend.position = "none")

```



## Pomiar termometrem referencyjnym
U pacjentów przeprowadzono pomiar temperatury przy pomocy bezdotykowego termometra - pomiar na skroni, standard stosowany na oddziale chirurgicznym. Poniższe wykresy ilustrują rozkład pomiarów temperatury u tych pacjentów przy pomocy standardowego termometra.

```{r}
hist(breaks = 20,end$patient_temperature,xlim=c(35,38),main="First Measurment",xlab="Temperature")

```

Takich pomiarów termometrem referencyjnym wykonano między 3-6, co 12 godzin.  


```{r}
ggarrange(
  ggboxplot(end, "gender.factor", "patient_temperature",
            xlab="",ylab="Temp [C]",fill = "gender.factor",
            palette = c("#00AFBB", "#E7B800"))+
    theme(legend.position = "none"),
  ggboxplot(end, "gender.factor", "patient_temperature_2",
            xlab="",ylab="Temp [C]",fill = "gender.factor",
            palette = c("#00AFBB", "#E7B800"))+
    theme(legend.position = "none"),
  ggboxplot(end, "gender.factor", "patient_temperature_3",
            xlab="",ylab="Temp [C]",fill = "gender.factor",
            palette = c("#00AFBB", "#E7B800"))+
    theme(legend.position = "none"),
  ggboxplot(end, "gender.factor", "patient_temperature_4",
            xlab="",ylab="Temp [C]",fill = "gender.factor",
            palette = c("#00AFBB", "#E7B800"))+
    theme(legend.position = "none"),
  ggboxplot(end, "gender.factor", "patient_temperature_5",
            xlab="",ylab="Temp [C]",fill = "gender.factor",
            palette = c("#00AFBB", "#E7B800"))+
    theme(legend.position = "none"),
  ggboxplot(end, "gender.factor", "patient_temperature_6",
            xlab="",ylab="Temp [C]",fill = "gender.factor",
            palette = c("#00AFBB", "#E7B800"))+
    theme(legend.position = "none"))
```


<!--
#Change placement
start$change_placement_1 <- as.integer(start$change_placement_1)
start %>%
  group_by(gender.factor,change_placement_1.factor) %>%
  count() %>% ggpubr::ggbarplot(
    x = "gender.factor",
    fill = "change_placement_1.factor",
    y = "n",
    label = TRUE, lab.col = "red", lab.vjust = 1.2,
    position = position_fill(),palette = "Paired"
    ) + labs(fill="Change placement?",y="Proportion",x="Gender")

#no significant differences detected
summary(aov(data=end,patient_temperature~random.factor))
summary(aov(data=end,patient_temperature_2~random.factor))
summary(aov(data=end,patient_temperature_3~random.factor))
summary(aov(data=end,patient_temperature_4~random.factor))
summary(aov(data=end,patient_temperature_5~random.factor))
summary(aov(data=end,patient_temperature_6~random.factor))

#only last significant
summary(aov(data=end,patient_temperature~loc_detail_in_out.factor))
summary(aov(data=end,patient_temperature_2~loc_detail_in_out.factor))
summary(aov(data=end,patient_temperature_3~loc_detail_in_out.factor))
summary(aov(data=end,patient_temperature_4~loc_detail_in_out.factor))
summary(aov(data=end,patient_temperature_5~loc_detail_in_out.factor))
summary(aov(data=end,patient_temperature_6~loc_detail_in_out.factor))



#weird, second manual measurment significant difference between average temperatures
summary(aov(data=end,patient_temperature~gender.factor))
summary(aov(data=end,patient_temperature_2~gender.factor))
summary(aov(data=end,patient_temperature_3~gender.factor))
summary(aov(data=end,patient_temperature_4~gender.factor))
summary(aov(data=end,patient_temperature_5~gender.factor))
summary(aov(data=end,patient_temperature_6~gender.factor))

--> 
# Pomiar czujnikiem Warmie

```{r wszstkieczujniki, fig.height=8, fig.width=6, fig.cap="Średnia dzienna temperatura mierzona przez czujnik Warmie"}
## Describe the dataset in general. How many patients we have and what we see

daily_fun <- function(pacjent) {
  daily <- output[[pacjent]]$full_table
  daily <- daily %>% group_by(day) %>% summarise(mean_daily=mean(value,na.rm=T),sd_daily=sd(value,na.rm = T))
  daily <- daily %>% as.data.frame()
  return(daily)
}
daily_stats <- map(names_json,daily_fun)
names(daily_stats) <- names_json
daily_stats <- plyr::ldply(daily_stats, data.frame)
daily_stats <- daily_stats %>% rename(id=.id)

#Daily Mean, to find patients different from the norm

daily_mean_plot <-ggarrange(
ggboxplot(daily_stats, "id", "mean_daily",
          select = c(1:15),xlab="",ylab="",
          add = "jitter"),
ggboxplot(daily_stats, "id", "mean_daily",
          select = c(16:30),xlab="",ylab="",
          add = "jitter"),
ggboxplot(daily_stats, "id", "mean_daily",
          select = c(31:45),xlab="",ylab="",
          add = "jitter"),
ggboxplot(daily_stats, "id", "mean_daily",
          select = c(45:60),xlab="",ylab="",
          add = "jitter"),ncol=1)
annotate_figure(daily_mean_plot,
                bottom = text_grob("Patient ID", color = "black", face = "bold", size = 12),
                left = text_grob("Mean of Daily Temperature", color = "black",face="bold", rot = 90))

```

Na powyższym wykresie widać, że pomiary dobowe były spójne u większości pacjentów. U pacjenta 9, 26, 52, 56 średnie dobowe miały bardzo duży rozrzut i dlatego muszą zostać krytycznie zanalizowane. U tych pacjentów wachania w średnich dobowych polegają najprawdopodobniej na częstszym zdejmowaniu czujnika z miejsca pomiaru. 

Poniżej wykres odchylenia standardowego w tych samych pomiarach.

```{r fig.height = 7, fig.width=6}
#Daily SD, to see the cyclicality of temperatures( if a large dispersion can be determined the absence of cyclicality)

daily_sd_plot <-ggarrange(
  ggboxplot(daily_stats, "id", "sd_daily",
            select = c(1:15),xlab="",ylab=""),
  ggboxplot(daily_stats, "id", "sd_daily",
            select = c(16:30),xlab="",ylab=""),
  ggboxplot(daily_stats, "id", "sd_daily",
            select = c(31:45),xlab="",ylab=""),
  ggboxplot(daily_stats, "id", "sd_daily",
            select = c(45:60),xlab="",ylab=""),ncol=1)
annotate_figure(daily_sd_plot,
                bottom = text_grob("Patient ID", color = "black", face = "bold", size = 12),
                left = text_grob("SD of Daily Temperature", color = "black",face="bold", rot = 90))


```

# Różnice w pomiarach temp między warmie a termometrem referencyjnym

Optymalnie różnice pomiarowe powinny być jak najnmniejsze. Widzimy na poniższym wykresie, że u niektórych pacjentów były one dramatycznie wysokie - co prawdopodobnie nie jest zależne od sensora warmie, lecz od nieprawidłowego udokumentowania czasu pomiaru przy pomocy termometra referencyjnego (lub braku umieszczenia czujnika Warmie na skórzy kiedy wykoanany został pomiar termometrem referencyjnym).

Widzimy, że u pacjenta nr 52 różnica w pomiarach była jednorazowo ponad 30 stopni, co sugeruje że w momencie pomiaru czuujnik warmie nie był założony. 


```{r diffplot, fig.cap="Różnice pomiarowe w pomiarach czujnika Warmie względem termometra referencyjnego. ", fig.height=7, fig.width=6}
#Mean difference manual/sensor per patient

mean_diff_plot <-ggarrange(
  ggboxplot(comp, "id", "diff_value",
            select = c(1:15),xlab="",ylab=""),
  ggboxplot(comp, "id", "diff_value",
            select = c(16:30),xlab="",ylab=""),
  ggboxplot(comp, "id", "diff_value",
            select = c(31:45),xlab="",ylab=""),
  ggboxplot(comp, "id", "diff_value",
            select = c(45:60),xlab="",ylab=""),ncol=1)
annotate_figure(mean_diff_plot,
                bottom = text_grob("Patient ID", color = "black", face = "bold", size = 12),
                left = text_grob("Difference Value", color = "black",face="bold", rot = 90))


```


```{r, fig.width= 6,fig.height=6}
barplot_fun <- function(data,var,namex){
  var <- enquo(var)
  data <- data %>% rename(x=!!var)
a <- data %>%
  group_by(x) %>%
  count() %>%
  ggpubr::ggbarplot(
    x = "x",
    fill = "x",
    y = "n",
    label = TRUE, lab.col = "black", lab.vjust = 1.2,
    position = position_dodge2(),
    palette = get_palette(palette = "Oranges",5),
  )+labs(x=namex,y="Proportion")+
  font("xy.text", size = 10, color = "black")+
  theme(legend.position = "none")


a <- ggpar(a,
               font.x = c(11, "bold"),
               font.y = c(11, "bold"),
               font.legend = c(9,"bold"))
return(a)
}

ggarrange(
barplot_fun(start,gender.factor,"Gender"),
barplot_fun(start,surgery.factor,"Surgery exptected?"),
barplot_fun(end,comfort.factor,"Sensor WARMIE rate of comfortable"),
barplot_fun(start,random.factor,"Randomization group"),
labels = (LETTERS[1:4])
)


```




<!---
#The majority of patients do not have complete 6 observations compared to manual and sensory measurements. This is due to two conditions:
#- not all patients had 6 manual measurements
#- the nearest sensory measurement occurred at a distance of more than 5 minutes from the manual measurement


## Identify features that are indicative of attaching the sensor



## Identify features that tell us about temperature change (increas decrease)



## Describe the temperature changes in time. What is daily difference sd and trend



## Identify and compare if we can see patterns that are in multiple patients.
-->

# Wykresy pomiarowe u poszczególnych pacjentów 

```{r}
map(names(output),function(x){
  output[[x]]$plot+
    labs(title = paste0("Pat #", x))
})
```

# Podsumowanie

1. Na wykresach widoczne są dobowe wahania temperatury mierzonej przez sensor. 
2. Temperatura podczas snu jest zwykle bardziej stabilna niż w dzień i lepiej nadaje się do monitorowania.
3. Temperatura podczas godzin porannych jest zwykle najniższa, co może być spowodowane porannym uwalnianiem kortyzonu, który powoduje centralizcję krążenia i tym samym niższą temperaturę skóry. 

# Następne kroki

1. Następnym elementem analizy będzie zastosowanie algorytmów do automatycznej ekstrakcji zdarzeń (automatic feature extraction) z ciągłych pomiarów temperatury. 
2. Weryfikacja użyteczości zastosowania metod analizy spectrum do oceny dobowych zmian temperatury.
3. Próba predykcji temperatury rdzenia na podstawie temperatury skóry.
4. Publikacja dancych w Journalu akademickim. 



